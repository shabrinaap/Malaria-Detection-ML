<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malaria Detection</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <header>
        <div class="logo-container">
            <img src="{{ url_for('static', filename='images/ugm-logo.png') }}" alt="UGM Logo" class="logo">
            <img src="{{ url_for('static', filename='images/plasmotec-logo.png') }}" alt="Plasmotec Logo" class="logo2">
        </div>
        <nav>
            <ul>
                <li><a href="{{ url_for('home') }}" class="active">Home</a></li>
                <li><a href="{{ url_for('about') }}">Meet Our Team</a></li>
                <li><a href="{{ url_for('faq') }}">FAQ</a></li>
                <li><a href="{{ url_for('helpdesk') }}">Help Desk</a></li>
                {% if session.get('user') %}
                    <li><a href="{{ url_for('logout') }}">Logout</a></li>
                {% else %}
                    <li><a href="{{ url_for('login') }}">Login</a></li>
                    <li><a href="{{ url_for('sign_up') }}">Sign Up</a></li>
                {% endif %}        
            </ul>
            {% if session.get('user') %}
                <span class="welcome-text">Welcome, {{ session.get('user') }}</span>
            {% endif %}
        </nav>
    </header>
    <main>
        <!-- Existing sections -->
        <section class="intro-section">
            <img src="{{ url_for('static', filename='images/plasmotec-logo2.png') }}" alt="Plasmotec Logo" class="logo3">
            <div class="intro-text">
                <h1>A Web-Based Malaria Detection and Classification Using Blood Cell Images</h1>
            </div>
        </section>
        <section class="malaria-stats">
            <h2>Malaria is Still Endemic in 85 Countries</h2>
            <div class="stats-content">
                <div class="stats-text">
                    <p>
                        WHO's 2023 World Report found out there were <b>249 million malaria cases in 2022</b>.
                        This is an <b>increase of 5 million</b> compared to 2021, an effect of catastrophic weather
                        events, population growth, and conflict/forced migration. However, the number of lives
                        lost to malaria declined marginally compared to 2021, to <b>608,000 deaths</b>. 94% of cases
                        and 95% of deaths were in the WHO African Region.
                    </p>
                    <p>
                        Four countries, like Nigeria (27%), the Democratic Republic of the Congo (12%),
                        Uganda (5%), and Mozambique (4%) accounted for almost half of all cases globally.
                    </p>
                </div>
                <div class="stats-map">
                    <img src="{{ url_for('static', filename='images/map-1.png') }}" alt="Malaria Endemic Countries">
                </div>
            </div>
            <div class="content-container">
                <div class="image-section">
                    <img src="{{ url_for('static', filename='images/map-2.jpg') }}" alt="Malaria Map of Indonesia">
                </div>
                <div class="text-section">
                    <p>
                        In 2022, <b>Indonesia 443,530 confirmed malaria cases</b> are recorded, with the majority concentrated
                        in Papua and West Papua. Encouragingly, regions such as Java and Bali have made significant
                        progress, with only one district still reporting malaria transmission, with residents often experiencing
                        multiple infections annually. Areas like Mimika in Papua face critical challenges, with an Annual parasite
                        Incidence (API) exceeding <b>400 cases per 1,000 people</b>.
                    </p>
                    <p>
                        Encouragingly, regions such as Java and Bali have made significant progress, with <b>only one district</b> still 
                        reporting malaria transmission.
                    </p>
                </div>
            </div>            
        </section>
        <section class="what-is-malaria">
            <h2>What is Malaria?</h2>
            <div class="malaria-description">
                <div class="malaria-image">
                    <img src="{{ url_for('static', filename='images/mosquito.jpg') }}" alt="Mosquito">
                </div>
                <div class="malaria-text">
                    <div class="malaria-desc">
                        Malaria is a life-threatening disease caused by <b><i>Plasmodium</i> parasites</b>, 
                        transmitted through the bite of infected female Anopheles mosquitoes. Common 
                        in tropical regions, <b>malaria attacks red blood cells</b>, leading to <b>anemia</b>, severe 
                        complications like <b>organ damage or death</b>, and potential long-term effects such 
                        as <b>brain damage or physical disabilities</b> in children. While serious, malaria is 
                        preventable and treatable with proper care.
                    </p>
                    </div>
                    <p>
                    <div class="malaria-symptoms">
                        <p>
                            <div class="common-symptoms">
                                <b>Common Symptoms:</b>
                                <ul>
                                    <li>High Fever</li>
                                    <li>Chills</li>
                                    <li>Sweating</li>
                                    <li>Headache</li>
                                    <li>Nausea</li>                                   
                                </ul>
                            </div>

                            <div class="severe-symptoms">
                                <b>Severe Symptoms:</b>
                                <ul>
                                    <li>Breathing Difficulties</li>
                                    <li>Seizures</li>
                                    <li>Confusion</li>
                                    <li>Organ Failure</li>
                                    <li>Low Blood Pressure</li>
                                </ul>
                            </div>
                            </div>
                        </p>
                        <p>

                            <div class="severe-symptoms">

                            </div>
                        </p>
                    </div>
                </div>
                </div>
            <p>
                <div class = "malaria-desc2">
                    Malaria is a highly dangerous disease with a high mortality rate, transmitted through the bites of infected female Anopheles mosquitoes, 
                    particularly in tropical regions. <b>Early and accurate detection plays a crucial role in reducing fatalities</b>. While microscopy remains the 
                    gold standard for malaria diagnosis, the growing number of patients and the limited availability of parasitologists highlight the need for an 
                    automated detection system to support their work. To address this issue, <b>we developed an AI-based malaria detection model using the 
                    MobileNetV2 architecture, implemented as a web-based platform</b>.
                </div>
            </p>
        </section>
       <!-- New Upload Section -->
       <section class="upload-section">
        <h2>Upload Your Blood Cell Image</h2>
        <div class="image-row">
            <img src="{{ url_for('static', filename='images/image1.jpg') }}" alt="Blood Cell Image 1">
            <img src="{{ url_for('static', filename='images/image2.jpg') }}" alt="Blood Cell Image 2">
            <img src="{{ url_for('static', filename='images/image4.jpg') }}" alt="Blood Cell Image 3">
            <img src="{{ url_for('static', filename='images/image3.jpg') }}" alt="Blood Cell Image 4">
        </div>

        <form id="upload-form" enctype="multipart/form-data" class="upload-form" method="POST" 
            action="{{ url_for('predict_route') }}" onsubmit="handleFormSubmit();">
            <label for="image">Upload Image:</label>
            <div class="form-control">
                <input type="file" id="image" name="image" accept=".png, .jpg, .jpeg" required>
            </div>
            <button type="submit" class="btn-submit">Submit</button>
        </form>

        <div id="loading-animation" style="display: none;">
            <div class="spinner"></div>
            <p>Processing...</p> 
        </div>

        <section class="result-section" id="prediction-result" style="display:none;">
            <h3 id="prediction-title"></h3>
            <!-- Colored Box for Result -->
            <div id="prediction-box" class="result-box"></div>
            <div class="result-container">
                <!-- Image Column -->
                <div class="result-image">
                    <img id="uploaded-image" src="#" alt="Uploaded Image">
                </div>
        
                <!-- Confidence Column -->
                <div class="result-details">
                    <p id="confidence-text"></p>
                </div>
            </div>
        
            
        
            <!-- Optional: Add a descriptive message below -->
            <div id="prediction-message"></div>
        </section>
        

        <!-- JavaScript for Handling Image Upload and Result Display -->
        <script>
            function handleFormSubmit() {
                // Hide previous prediction results before submitting
                document.getElementById('prediction-result').style.display = 'none';
                // Show loading animation
                document.getElementById('loading-animation').style.display = 'block';
            }

            document.getElementById("upload-form").addEventListener("submit", function(event) {
    event.preventDefault(); // Prevent default form submission

    let formData = new FormData(this);
    let resultSection = document.getElementById("prediction-result");
    let predictionTitle = document.getElementById("prediction-title");
    let confidenceText = document.getElementById("confidence-text");
    let uploadedImage = document.getElementById("uploaded-image");
    let predictionMessage = document.getElementById("prediction-message");
    let predictionBox = document.getElementById("prediction-box");

    // Display loading animation
    document.getElementById('loading-animation').style.display = 'block';

    fetch("{{ url_for('predict_route') }}", {
        method: "POST",
        body: formData
    })
    .then(response => {
    if (response.ok) {
        return response.json();  // Parse JSON only if the response is OK
    } else {
        throw new Error("Server returned an error response");
    }
})
    .then(data => {
        document.getElementById('loading-animation').style.display = 'none';

        if (data.error) {
            alert("Error: " + data.error);
        } else {
            // Show prediction result
            resultSection.style.display = 'block';



            // Set confidence percentage
            let confidencePercentage = (data.confidence * 100).toFixed(2);
            confidenceText.innerText = `${confidencePercentage}%`;

                        // Set message based on prediction
                        if (data.prediction === "Uninfected") {
                            predictionBox.innerText = "Result: Uninfected";
                            predictionBox.className = "result-box uninfected-box";
                                        // Set uploaded image src
                            uploadedImage.src = URL.createObjectURL(formData.get("image"));
                            predictionMessage.innerHTML = `
                                There is a <strong>${confidencePercentage}%</strong> chance that the blood smear image shows <strong>no signs of malaria infection</strong>. 
                                The detected features are unlikely to indicate the presence of malaria parasites, but the possibility of a low-level infection cannot be completely ruled out. 
                                The blood sample is most likely free from <i>Plasmodium</i> parasites, suggesting a low risk of infection.
                            `;
                            
                        } else if (data.prediction === "Parasitized") {
                            predictionBox.className = "result-box parasitized-box";
                            predictionBox.innerText = "Result: Parasitized";
                                        // Set uploaded image src
                            uploadedImage.src = URL.createObjectURL(formData.get("image"));
                            predictionMessage.innerHTML = `
                                There is a <strong>${confidencePercentage}%</strong> chance that the blood smear image shows the <strong>presence of malaria parasites</strong>. 
                                The identified features strongly suggest a positive result for malaria infection, and immediate medical attention is recommended.
                                The blood sample indicates the presence of <i>Plasmodium</i> parasites, which are responsible for malaria.
                            `;
                        }
                    }
                })
                .catch(error => {
                    document.getElementById('loading-animation').style.display = 'none';
                    alert("Error: " + error);
                });
            });


            </script>            
        </section>
    </main>
</body>
</html>
